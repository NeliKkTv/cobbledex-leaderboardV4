name: Cron leaderboard (Pages)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"   # toutes les 15 minutes

permissions:
  contents: read
  pages: write        # obligatoire pour déployer Pages
  id-token: write     # obligatoire pour déployer Pages

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    environment:
      name: github-pages

    steps:
      # 1) Récupérer le repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3) Installer les dépendances si requirements.txt existe
      - name: Install dependencies (if any)
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "Aucun requirements.txt détecté — on continue."
          fi

      # 4) Lancer ton script Python
      - name: Run python main.py
        run: |
          echo "=== Lancement du script Python ==="
          python main.py
          echo "=== Fin du script ==="

      # 5) Vérifier que l'image existe
      - name: Check generated image
        run: |
          test -f images/top3.png || (echo "❌ images/top3.png introuvable" && exit 1)
          echo "✅ Image générée : images/top3.png"

      # 6) Préparer le répertoire public pour GitHub Pages
      - name: Prepare site folder
        run: |
          rm -rf public
          mkdir -p public/images
          cp images/top3.png public/images/top3.png
          # petite page d'aperçu (optionnel)
          cat > public/index.html <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <title>Leaderboard</title>
          <style>
            body{margin:0;background:#0b0e14;color:#ddd;font-family:system-ui,Segoe UI,Roboto,Arial}
            main{max-width:1200px;margin:40px auto;padding:0 16px}
            h1{font-weight:600;margin:0 0 16px}
            img{max-width:100%;height:auto;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
            a{color:#8ab4ff}
          </style>
          <main>
            <h1>Leaderboard</h1>
            <p>Image publiée via GitHub Pages (mise à jour par le workflow).</p>
            <p><a href="./images/top3.png">Ouvrir l'image seule</a></p>
            <img src="./images/top3.png" alt="Leaderboard">
          </main>
          HTML

      # 7) Uploader l'artefact "site" pour Pages
      - name: Upload artifact to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      # 8) Déployer sur GitHub Pages
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

      # 9) Afficher le lien final vers l'image
      - name: Show final URL
        run: |
          PAGE_URL="${{ steps.deploy.outputs.page_url }}"
          FINAL_URL="${PAGE_URL}images/top3.png"
          echo "✅ Lien fixe (Pages) : ${FINAL_URL}"
          echo "::notice title=URL de l'image::${FINAL_URL}"
