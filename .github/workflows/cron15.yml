name: cron15

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"   # toutes les 15 min (UTC)

permissions:
  contents: write

env:
  STABLE_FILE: images/top3.png
  # Lien fixe (à mettre dans ton projecteur en jeu) :
  JSDELIVR: https://cdn.jsdelivr.net/gh/NeliKkTv/cobbledex-leaderboardV4@main/images/top3.png
  PURGE:    https://purge.jsdelivr.net/gh/NeliKkTv/cobbledex-leaderboardV4@main/images/top3.png
  WEBHOOK:  ${{ secrets.DISCORD_WEBHOOK_URL }}  # si tu n’as pas de secret, la step Discord sera skip

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Ensure folders
        run: |
          mkdir -p images data staticdata

      - name: Run python main.py
        run: |
          echo "Lancement du script…"
          python main.py

      - name: Commit & push changes (images/top3.png)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-files --error-unmatch "${{ env.STABLE_FILE }}" >/dev/null 2>&1; then
            git add "${{ env.STABLE_FILE }}"
          fi

          if ! git diff --cached --quiet; then
            git commit -m "Auto-update leaderboard image"
            git push
          else
            echo "Aucun changement à pousser."
          fi

      - name: Purger le cache jsDelivr + réchauffer
        run: |
          set -e
          echo "Purge: ${{ env.PURGE }}"
          curl -sS "${{ env.PURGE }}" >/dev/null || true

          echo "Warm:  ${{ env.JSDELIVR }}"
          # On “tire” l’image pour remplir le cache
          curl -sI "${{ env.JSDELIVR }}" | sed -n '1,12p' || true

      - name: Notifier Discord (lien FIXE + aperçu rafraîchi)
        if: env.WEBHOOK != ''
        run: |
          set -e
          now=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          payload=$(jq -n \
            --arg content "**Leaderboard mis à jour** — $now\nLien fixe (sans cache) :\n${{ env.JSDELIVR }}?t=$(date +%s)" \
            '{content: $content}')
          curl -sS -H "Content-Type: application/json" \
               -d "$payload" \
               "${{ env.WEBHOOK }}" >/dev/null || true
