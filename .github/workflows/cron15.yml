name: Cron leaderboard (robuste)

on:
  schedule:
    - cron: "*/15 * * * *"   # ExÃ©cution toutes les 15 minutes
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Cloner le dÃ©pÃ´t
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # 2ï¸âƒ£ Installer Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3ï¸âƒ£ Installer les dÃ©pendances
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 4ï¸âƒ£ VÃ©rification du fichier config.ini
      - name: VÃ©rification du fichier config.ini
        run: |
          echo "=== VÃ©rification du fichier config.ini ==="
          if [ ! -f config.ini ]; then
            echo "::error ::config.ini introuvable Ã  la racine du dÃ©pÃ´t."
            exit 1
          fi
          echo "âœ… Fichier config.ini trouvÃ©."
          echo "----- Contenu brut -----"
          cat config.ini
          echo "------------------------"

      # 5ï¸âƒ£ Normaliser et forcer le mode SFTP
      - name: Normaliser/forcer config.ini (mode=sftp)
        shell: bash
        run: |
          echo "==> Normalisation du fichier config.ini..."
          python - <<'PY'
          import pathlib, re

          p = pathlib.Path("config.ini")
          if not p.exists():
              raise SystemExit("âŒ Fichier config.ini introuvable")

          data = p.read_text(encoding="utf-8").replace("\r\n", "\n")

          if "[MODE]" not in data:
              data = "[MODE]\nmode = sftp\n\n" + data
          else:
              data = re.sub(r"(?<=mode\s*=\s*)(\w+)", "sftp", data)

          p.write_text(data, encoding="utf-8")
          print("âœ… config.ini normalisÃ© et mode forcÃ© Ã  sftp.")
          PY

      # 6ï¸âƒ£ ExÃ©cution du script principal Python
      - name: ExÃ©cution du script principal
        run: |
          echo "=== Lancement du script Python ==="
          python main.py

      # 7ï¸âƒ£ Commit & push de lâ€™image gÃ©nÃ©rÃ©e (fonctionne en repo public)
      - name: Commit & push updated leaderboard
        if: success()
        run: |
          echo "=== Commit et push du leaderboard ==="
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if [ -f images/top3.png ]; then
            echo "âœ… Fichier top3.png trouvÃ©, prÃ©paration du commit..."
            git add images/top3.png
            git commit -m "Update leaderboard image [auto]" || echo "Aucun changement Ã  commit."
            git pull origin main --rebase || true
            git push https://github.com/NelikkTv/cobbledex-leaderboardV4.git HEAD:main || true
          else
            echo "âš ï¸ Aucun fichier images/top3.png trouvÃ©, aucun push effectuÃ©."
          fi

      # 8ï¸âƒ£ Purger le cache jsDelivr (rafraÃ®chit ton lien public)
      - name: Purger le cache jsDelivr
        if: success()
        run: |
          echo "=== Purge du cache jsDelivr ==="
          curl -X PURGE "https://cdn.jsdelivr.net/gh/NelikkTv/cobbledex-leaderboardV4/images/top3.png" || true
          echo "âœ… Cache jsDelivr rafraÃ®chi."

      # 9ï¸âƒ£ (Optionnel) Ã‰tape Discord Ã  activer plus tard
      # - name: Envoyer notification Discord
      #   if: success()
      #   run: |
      #     curl -H "Content-Type: application/json" \
      #          -d '{"content":"ðŸŽ‰ Nouveau leaderboard gÃ©nÃ©rÃ© !\nhttps://cdn.jsdelivr.net/gh/NelikkTv/cobbledex-leaderboardV4/images/top3.png"}' \
      #          ${{ secrets.DISCORD_WEBHOOK_URL }}
