name: Run Python script every 15 min

on:
  schedule:
    - cron: "*/15 * * * *"   # Toutes les 15 minutes (UTC)
  workflow_dispatch:         # Permet de le lancer manuellement

concurrency:
  group: python-cron
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      SFTP_HOST: ${{ secrets.SFTP_HOST }}
      SFTP_USER: ${{ secrets.SFTP_USER }}
      SFTP_PASS: ${{ secrets.SFTP_PASS }}

    steps:
      # 1. R√©cup√©ration du repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Mise en place de Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Installation des d√©pendances
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Nettoyage du config.ini (fin de ligne + BOM)
      - name: Sanitize config.ini (LF, no BOM)
        run: |
          perl -pi -e 's/\r\n/\n/g' config.ini
          sed -i '1s/^\xEF\xBB\xBF//' config.ini

      # 5. Debug : lecture du mode depuis le config.ini
      - name: Debug lecture du mode (via Python)
        run: |
          python - <<'PY'
          import configparser
          cfg = configparser.ConfigParser()
          cfg.read('config.ini', encoding='utf-8')
          for section in cfg.sections():
              print(f"[{section}]")
              for k, v in cfg.items(section):
                  print(f"  {k} = {v}")
          print("\nValeur de mode =", cfg.get('MODE', 'mode', fallback='??'))
          PY

      # 6. Ex√©cution du script principal
      - name: Run python main.py
        run: |
          echo "Lancement du script..."
          python main.py

      # 7. Commit & push (si le script a g√©n√©r√© des fichiers)
      - name: Commit & push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --cached --quiet || (git commit -m "Auto-update leaderboard from cron" && git push)

      # 8. Purge du cache jsDelivr + r√©chauffement
      - name: Purger le cache jsDelivr + r√©chauffer
        run: |
          set -e
          FILE="images/top3.png"
          URL="https://cdn.jsdelivr.net/gh/NeliKkTwitch/cobbledex-leaderboardV4@main/${FILE}"
          PURGE="https://purge.jsdelivr.net/gh/NeliKkTwitch/cobbledex-leaderboardV4@main/${FILE}"

          echo "Purge jsDelivr: $PURGE"
          curl -sS "$PURGE" > /dev/null || true

          echo "Warm jsDelivr: $URL"
          curl -s "$URL" | head -c 20 > /dev/null || true

      # 9. Notification Discord avec lien fixe (et aper√ßu √† jour)
      - name: Notifier Discord avec lien FIXE + aper√ßu rafra√Æchi
        run: |
          set -e
          FILE_URL="https://cdn.jsdelivr.net/gh/NeliKkTwitch/cobbledex-leaderboardV4@main/images/top3.png"
          PAYLOAD=$(jq -n --arg url "$FILE_URL" \
            '{content: "**üìä Nouveau leaderboard mis √† jour !**", embeds: [{image: {url: $url}}]}')
          curl -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK"
