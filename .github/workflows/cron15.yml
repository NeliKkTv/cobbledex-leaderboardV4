name: cron15
on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Set up job
        run: echo "DÃ©marrage du workflow..."

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      ####################################################################
      # ðŸ”§ GÃ©nÃ¨re config.ini Ã  partir des SECRETS GitHub
      ####################################################################
      - name: GÃ©nÃ©rer config.ini depuis les secrets
        run: |
          cat > config.ini << 'EOF'
          [GITHUB]
          Enable=false
          Token=
          RepoOwner=NeliKkTwitch
          RepoName=cobbledex-leaderboardV4
          Branch=main

          [MODE]
          mode=sftp

          [SFTP]
          host=${{ secrets.SFTP_HOST }}
          port=${{ secrets.SFTP_PORT }}
          username=${{ secrets.SFTP_USER }}
          password=${{ secrets.SFTP_PASS }}
          remote_root=${{ secrets.SFTP_REMOTE_DIR }}

          [LEADERBOARD]
          Enable=true
          category=minecraft:custom
          subcategory=minecraft:pokemon_registered
          CreateCSV=true
          CSVPath=total.csv
          CreateCSVMoney=false
          CSVPathMoney=money.csv

          [TOPIMAGE]
          Enable=true
          NDplayers=30
          Width=3
          Height=1
          ImagePath=images/top3.png
          Titles=Leaderboard - RANKS 1-10,Leaderboard - RANKS 11-20,Leaderboard - RANKS 21-30
          Leaderboards=vanilla/minecraft:custom/minecraft:pokemon_registered,vanilla/minecraft:custom/minecraft:pokemon_registered,vanilla/minecraft:custom/minecraft:pokemon_registered
          EOF

          echo "âœ… Fichier config.ini gÃ©nÃ©rÃ© avec succÃ¨s."
          sed -n '1,60p' config.ini

      ####################################################################
      # ðŸ§  ExÃ©cute ton script Python principal
      ####################################################################
      - name: Run python main.py
        run: |
          echo "Lancement du script..."
          python main.py

      ####################################################################
      # ðŸ“¤ Commit & push si des fichiers ont changÃ©
      ####################################################################
      - name: Commit & push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images/top3.png total.csv || true
          if git diff --cached
