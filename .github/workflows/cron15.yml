name: cron15
on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # (Optionnel) V√©rifie que secrets/vars existent (n'imprime rien de sensible)
      - name: Sanity check secrets/vars
        run: |
          test -n "${{ secrets.SFTP_PASS }}" || (echo "‚ùå Secret SFTP_PASS manquant"; exit 1)
          test -n "${{ secrets.DISCORD_WEBHOOK_URL }}" || (echo "‚ùå Secret DISCORD_WEBHOOK_URL manquant"; exit 1)
          test -n "${{ vars.SFTP_HOST }}" || (echo "‚ùå Var SFTP_HOST manquante"; exit 1)
          test -n "${{ vars.SFTP_PORT }}" || (echo "‚ùå Var SFTP_PORT manquante"; exit 1)
          test -n "${{ vars.SFTP_USER }}" || (echo "‚ùå Var SFTP_USER manquante"; exit 1)
          test -n "${{ vars.SFTP_REMOTE_DIR }}" || (echo "‚ùå Var SFTP_REMOTE_DIR manquante"; exit 1)

      ####################################################################
      # üîß G√©n√®re config.ini √† partir des Variables + Secrets GitHub
      ####################################################################
      - name: G√©n√©rer config.ini depuis variables + secrets
        run: |
          cat > config.ini << 'EOF'
          [GITHUB]
          Enable=false
          Token=
          RepoOwner=NeliKkTwitch
          RepoName=cobbledex-leaderboardV4
          Branch=main

          [MODE]
          mode=sftp

          [SFTP]
          host=${{ vars.SFTP_HOST }}
          port=${{ vars.SFTP_PORT }}
          username=${{ vars.SFTP_USER }}
          password=${{ secrets.SFTP_PASS }}
          remote_root=${{ vars.SFTP_REMOTE_DIR }}

          [LEADERBOARD]
          Enable=true
          category=minecraft:custom
          subcategory=minecraft:pokemon_registered
          CreateCSV=true
          CSVPath=total.csv
          CreateCSVMoney=false
          CSVPathMoney=money.csv

          [TOPIMAGE]
          Enable=true
          NDplayers=30
          Width=3
          Height=1
          ImagePath=images/top3.png
          Titles=Leaderboard - RANKS 1-10,Leaderboard - RANKS 11-20,Leaderboard - RANKS 21-30
          Leaderboards=vanilla/minecraft:custom/minecraft:pokemon_registered,vanilla/minecraft:custom/minecraft:pokemon_registered,vanilla/minecraft:custom/minecraft:pokemon_registered
          EOF
          echo "‚úÖ Fichier config.ini g√©n√©r√©."

      - name: Run python main.py
        run: |
          echo "Lancement du script‚Ä¶"
          python main.py

      - name: Commit & push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images/top3.png total.csv || true
          if git diff --cached --quiet; then
            echo "Aucun changement √† valider."
          else
            git commit -m "Auto-update leaderboard + image"
            git push
          fi

      - name: Purger le cache jsDelivr + r√©chauffer
        run: |
          set -e
          FILE="images/top3.png"
          URL="https://cdn.jsdelivr.net/gh/NeliKkTwitch/cobbledex-leaderboardV4@main/${FILE}"
          PURGE="https://purge.jsdelivr.net/gh/NeliKkTwitch/cobbledex-leaderboardV4@main/${FILE}"

          echo "Purge jsDelivr: $PURGE"
          curl -sS "$PURGE" > /dev/null

          echo "Pause 3s..."
          sleep 3

          echo "Warm jsDelivr: $URL"
          curl -sI "$URL" | sed -n '1,2p'

      - name: Notifier Discord avec lien FIXE + aper√ßu rafra√Æchi
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -e
          URL="https://cdn.jsdelivr.net/gh/NeliKkTwitch/cobbledex-leaderboardV4@main/images/top3.png"
          payload=$(jq -n --arg content "**Leaderboard mis √† jour !** üèÜ\n$URL" '{content: $content}')
          curl -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"

      - name: Done
        run: echo "‚úÖ Termin√©"
