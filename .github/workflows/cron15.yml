name: Cron leaderboard (debug mode)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: VÃ©rification du fichier config.ini
        run: |
          echo "==== VÃ©rification du fichier config.ini ===="
          if [ ! -f "config.ini" ]; then
            echo "âŒ ERREUR : config.ini est introuvable !"
            exit 1
          fi
          echo "âœ… Fichier config.ini trouvÃ©."
          echo "----- Contenu brut -----"
          head -n 30 config.ini || true
          echo "------------------------"

          echo "Recherche du mode dans le fichier..."
          MODE=$(grep -E '^mode *= *' config.ini | cut -d '=' -f2 | xargs)
          if [ -z "$MODE" ]; then
            echo "âŒ Aucun mode trouvÃ© dans config.ini !"
            exit 1
          fi
          echo "ðŸŸ© Mode dÃ©tectÃ© : '$MODE'"

          if [[ "$MODE" != "manual" && "$MODE" != "local" && "$MODE" != "ftp" && "$MODE" != "sftp" ]]; then
            echo "âŒ Mode invalide : $MODE"
            echo "Le mode doit Ãªtre 'manual', 'local', 'ftp' ou 'sftp'."
            exit 1
          fi
          echo "âœ… Mode valide, on continue."

      - name: Run python main.py
        run: |
          echo "Lancement du script..."
          python main.py

      - name: Commit & push changes (images/top3.png)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images/top3.png || true
          git commit -m "Auto-update leaderboard" || echo "Rien Ã  commit"
          git push || echo "Push dÃ©jÃ  Ã  jour"

      - name: Purger le cache jsDelivr + rÃ©chauffer
        run: |
          set -e
          FILE="images/top3.png"
          URL="https://cdn.jsdelivr.net/gh/NeliKkTv/cobbledex-leaderboardV4@main/${FILE}"
          PURGE="https://purge.jsdelivr.net/gh/NeliKkTv/cobbledex-leaderboardV4@main/${FILE}"

          echo "Purge jsDelivr: $PURGE"
          curl -sS "$PURGE" > /dev/null

          sleep 3
          echo "Warm jsDelivr: $URL"
          curl -I "$URL" | sed -n '1,2p'

