name: cron15

on:
  schedule:
    # ExÃ©cution toutes les 5 minutes
    - cron: "*/5 * * * *"
  workflow_dispatch: # Permet de le lancer manuellement si besoin

jobs:
  r:
    runs-on: ubuntu-latest

    steps:
      - name: Set up job
        run: echo "ğŸš€ Starting the CobbleDex Leaderboard automation"

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set timestamp variable
        id: time
        run: echo "TS=$(date -u +%s)" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure required folders exist
        run: |
          mkdir -p data/stats data/usercache data/playerdata data/cobblemonplayerdata data/vanilla data/staticdata images

      - name: Gate 15-minute marks only
        run: |
          set -e
          TS=$(date -u +%s)
          MINUTE=$(date -u +%M)
          echo "â±ï¸ Current UTC minute: $MINUTE"
          case "$MINUTE" in
            00|15|30|45)
              echo "âœ… In valid 15-minute window, continuing..."
              ;;
            *)
              echo "â­ï¸ Not in 15-minute window (00/15/30/45 UTC) â€” skipping run."
              exit 0
              ;;
          esac

      - name: Run main Python script
        run: |
          echo "ğŸ Running main.py..."
          python main.py
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Commit & push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images/top3.png || true
          git commit -m "Auto-update leaderboard image from cron" || echo "No changes to commit"
          git push origin main || echo "No push needed"

      - name: Send image link to Discord
        if: success()
        run: |
          echo "ğŸ“¤ Sending update to Discord..."
          curl -H "Content-Type: application/json" \
               -d "{\"content\":\"âœ… New leaderboard image generated! \nğŸ”— https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/images/top3.png\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Log execution time (UTC + France)
        run: |
          echo "âœ… Script executed successfully."
          echo "ğŸ•“ Current UTC time: $(date -u '+%H:%M:%S (UTC)')"
          echo "ğŸ‡«ğŸ‡· Current France time: $(TZ='Europe/Paris' date '+%H:%M:%S (FR)')"

      - name: Complete job
        run: echo "ğŸ‰ Job completed successfully!"
