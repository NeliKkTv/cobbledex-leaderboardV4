name: Run Python script every 15 min (robust)

on:
  schedule:
    - cron: "*/15 * * * *"   # toutes les 15 minutes (UTC)
  workflow_dispatch:

concurrency:
  group: python-cron
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Ensure required folders exist
        run: |
          mkdir -p data stats images staticdata

      - name: Run python main.py
        run: |
          python main.py

      - name: Commit & push changes (if any)
        id: commit
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            echo "committed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "Auto-update from cron: ${GITHUB_RUN_ID}"
            git push
            echo "committed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Purger le cache jsDelivr + réchauffer
        if: steps.commit.outputs.committed == 'true'
        run: |
          set -e
          REPO="${{ github.repository }}"
          FILE="images/top3.png"
          CDN="https://cdn.jsdelivr.net/gh/${REPO}@main/${FILE}"
          PURGE="https://purge.jsdelivr.net/gh/${REPO}@main/${FILE}"

          echo "Purge jsDelivr : $PURGE"
          curl -sS "$PURGE" > /dev/null || true

          echo "Warm jsDelivr : $CDN"
          sleep 3
          curl -sS "$CDN" | head -n 2 || true

      - name: Notifier Discord avec lien FIXE + aperçu rafraîchi
        if: steps.commit.outputs.committed == 'true'
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -e
          if [ -z "${WEBHOOK:-}" ]; then
            echo "WEBHOOK (DISCORD_WEBHOOK_URL) manquant ; on saute l’étape."
            exit 0
          fi

          REPO="${{ github.repository }}"
          FIX_URL="https://cdn.jsdelivr.net/gh/${REPO}@main/images/top3.png"
          PREVIEW_URL="${FIX_URL}?t=${{ github.run_id }}"

          payload="{\"content\":\"**Leaderboard mis à jour !**\",\"embeds\":[{\"description\":\"Lien fixe : ${FIX_URL}\",\"image\":{\"url\":\"${PREVIEW_URL}\"},\"color\":5814783}]}"

          http_code=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "$payload" "$WEBHOOK" || true)

          echo "Discord HTTP : $http_code"
          cat /tmp/resp.txt || true

          if [[ "$http_code" != 2* ]]; then
            echo "Échec Discord (HTTP $http_code)"
            exit 1
          fi
