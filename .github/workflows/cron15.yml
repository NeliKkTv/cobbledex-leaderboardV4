name: Cron leaderboard (robuste)

on:
  schedule:
    - cron: "*/15 * * * *"  # toutes les 15 minutes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-leaderboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # üß© V√©rification avanc√©e du fichier config.ini
      - name: V√©rification du fichier config.ini (robuste)
        run: |
          set -e
          echo "==== V√©rification du fichier config.ini ===="

          if [ ! -f config.ini ]; then
            echo "::error::config.ini introuvable √† la racine du repo."
            exit 1
          fi

          echo "‚úÖ Fichier config.ini trouv√©."
          echo "----- Contenu brut (quelques lignes) -----"
          sed -n '1,120p' config.ini | sed -e 's/\t/‚êâ/g'

          # 1Ô∏è‚É£ Supprimer BOM et retours chariot Windows
          sed -i '1s/^\xEF\xBB\xBF//' config.ini
          sed -i 's/\r//g' config.ini

          echo "-----------------------------------------"
          echo "Recherche du mode dans le fichier..."

          # 2Ô∏è‚É£ Extraire la valeur du mode
          MODE=$(
            awk -F'=' '
              BEGIN{IGNORECASE=1}
              /^\s*\[MODE\]\s*$/ {inmode=1; next}
              inmode && /^\s*\[/ {inmode=0}
              inmode && /^\s*mode\s*=/ {
                v=$2
                gsub(/\r/,"",v)
                gsub(/^[ \t"]+|[ \t"]+$/,"",v)
                print tolower(v)
                exit
              }
            ' config.ini
          )

          HEX=$(echo -n "$MODE" | xxd -p)
          echo "üü¢ Mode d√©tect√©   : '$MODE'"
          echo "üîé Mode en hex    : $HEX"

          # 3Ô∏è‚É£ Validation
          case "$MODE" in
            manual|local|ftp|sftp)
              echo "‚úÖ Mode valide : $MODE"
              ;;
            *)
              echo "::error::Mode invalide : '$MODE'. Le mode doit √™tre 'manual', 'local', 'ftp' ou 'sftp'."
              exit 1
              ;;
          esac

      # üöÄ Lancement du script Python
      - name: Run python main.py
        run: |
          echo "Lancement du script Python..."
          python main.py

      # ‚úÖ Commit automatique si des fichiers sont modifi√©s (par ex. images g√©n√©r√©es)
      - name: Commit & push changes (images/top3.png)
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add images/*.png || true
          git commit -m "Update leaderboard images [bot]" || echo "Aucun changement √† commit"
          git push || echo "Aucun push n√©cessaire"
