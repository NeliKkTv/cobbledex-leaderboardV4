name: Run Python script every 15 min

on:
  schedule:
    - cron: "*/15 * * * *"   # toutes les 15 min (UTC)
  workflow_dispatch:         # exécution manuelle possible

concurrency:
  group: python-cron
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    permissions:
      contents: write        # nécessaire pour commit/push

    env:
      # Secrets SFTP (Nitroserv)
      SFTP_HOST: ${{ secrets.SFTP_HOST }}
      SFTP_USER: ${{ secrets.SFTP_USER }}
      SFTP_PASS: ${{ secrets.SFTP_PASS }}

      # Discord (optionnel : si non défini, on skippe l’envoi)
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      # Fichier image généré (chemin dans le repo)
      FILE: images/top3.png

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run python main.py
        run: |
          set -e
          echo "Lancement du script…"
          python main.py

      - name: Commit & push changes (if any)
        run: |
          set -e
          git add -A
          if git diff --staged --quiet; then
            echo "Aucun changement à committer."
          else
            git -c user.name="github-actions[bot]" \
                -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
                commit -m "Auto-update from cron: $(date -u +%s)"
            git push
          fi

      - name: Purger le cache jsDelivr + réchauffer
        run: |
          set -e
          URL="https://cdn.jsdelivr.net/gh/${GITHUB_REPOSITORY}@main/${FILE}"
          PURGE="https://purge.jsdelivr.net/gh/${GITHUB_REPOSITORY}@main/${FILE}"

          echo "Purge jsDelivr : ${PURGE}"
          curl -sS "${PURGE}" -o /dev/null

          echo "Warm jsDelivr : ${URL}"
          sleep 2
          curl -sS "${URL}" -o /dev/null

      - name: Notifier Discord avec lien FIXE + aperçu rafraîchi
        if: ${{ env.DISCORD_WEBHOOK_URL != '' }}
        run: |
          set -e
          WEBHOOK="${DISCORD_WEBHOOK_URL}"
          FIX_URL="https://cdn.jsdelivr.net/gh/${GITHUB_REPOSITORY}@main/${FILE}"
          # Cache-buster juste pour l’aperçu Discord (lien cliquable = FIX_URL)
          PREVIEW="${FIX_URL}?_=$(date +%s)"

          read -r -d '' PAYLOAD <<'JSON'
          {
            "content": "**Leaderboard mis à jour** ✅",
            "embeds": [{
              "title": "Aperçu du leaderboard",
              "url": "FIX_URL",
              "image": {"url": "PREVIEW"}
            }]
          }
          JSON

          PAYLOAD="${PAYLOAD/FIX_URL/$FIX_URL}"
          PAYLOAD="${PAYLOAD/PREVIEW/$PREVIEW}"

          curl -sS -H "Content-Type: application/json" \
               -d "$PAYLOAD" "$WEBHOOK" -o /dev/null
