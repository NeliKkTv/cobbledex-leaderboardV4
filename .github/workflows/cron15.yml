name: Cron leaderboard (robuste)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Vérification du fichier config.ini
        run: |
          echo "=== Vérification du fichier config.ini ==="
          if [ ! -f config.ini ]; then
            echo "::error ::config.ini introuvable à la racine du dépôt."
            exit 1
          fi
          echo "✅ Fichier config.ini trouvé."
          echo "----- Contenu brut -----"
          cat config.ini
          echo "------------------------"

      - name: Normaliser/forcer config.ini (mode=sftp)
        shell: bash
        run: |
          echo "==> Normalisation du fichier config.ini..."
          python - <<'PY'
          import pathlib, re

          p = pathlib.Path("config.ini")
          if not p.exists():
              raise SystemExit("❌ Fichier config.ini introuvable")

          data = p.read_text(encoding="utf-8").replace("\r\n", "\n")

          if "[MODE]" not in data:
              data = "[MODE]\nmode = sftp\n\n" + data
          else:
              data = re.sub(r"(?<=mode\s*=\s*)(\w+)", "sftp", data)

          p.write_text(data, encoding="utf-8")
          print("✅ config.ini normalisé et mode forcé à sftp.")
          PY

      - name: Exécution du script principal
        run: |
          echo "=== Lancement du script Python ==="
          python main.py

      - name: Commit & push updated leaderboard
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images/top3.png || echo "⚠️ Aucun fichier top3.png trouvé."
          git commit -m "Update leaderboard image [auto]" || echo "Aucun changement à commit."
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Purger le cache jsDelivr
        if: success()
        run: |
          echo "=== Purge du cache jsDelivr ==="
          curl -X PURGE "https://cdn.jsdelivr.net/gh/NelikkTv/cobbledex-leaderboardV4/images/top3.png" || true
          echo "✅ Cache jsDelivr rafraîchi."
