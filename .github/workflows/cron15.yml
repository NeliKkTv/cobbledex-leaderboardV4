name: Cron leaderboard (robuste)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Vérification du fichier config.ini
        run: |
          echo "=== Vérification config.ini ==="
          test -f config.ini || { echo "::error ::config.ini manquant"; exit 1; }
          sed -n '1,120p' config.ini

      - name: Normaliser/forcer config.ini (mode=sftp)
        shell: bash
        run: |
          python - <<'PY'
          import pathlib, re
          p = pathlib.Path("config.ini")
          data = p.read_text(encoding="utf-8").replace("\r\n","\n")
          if "[MODE]" not in data:
              data = "[MODE]\nmode = sftp\n\n" + data
          else:
              data = re.sub(r"(?<=mode\s*=\s*)(\w+)", "sftp", data)
          p.write_text(data, encoding="utf-8")
          print("✅ config.ini normalisé (mode=sftp)")
          PY

      - name: Exécution du script principal
        run: |
          echo "=== Lancement du script Python ==="
          python main.py

      - name: Diagnostiquer l’image générée
        run: |
          echo "=== Diagnostics PNG ==="
          set -x
          ls -lah images || true
          if [ -f images/top3.png ]; then
            du -h images/top3.png
            sha256sum images/top3.png
          else
            echo "⚠️ images/top3.png introuvable"
          fi
          set +x

      - name: Commit & push (même sans diff)
        run: |
          echo "=== Commit/Push PNG ==="
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true

          git status -s
          if [ -f images/top3.png ]; then
            # Ajoute et tente un commit si diff
            git add images/top3.png
            git commit -m "Update leaderboard image [auto]" || echo "Aucun diff: commit vide forcé"
          else
            echo "⚠️ PNG absent: commit vide pour forcer un push"
            git commit --allow-empty -m "Keep-alive commit (no image)"
          fi

          git push origin HEAD:main || true

      - name: Purger jsDelivr + réchauffer l’URL
        run: |
          set -x
          URL="https://cdn.jsdelivr.net/gh/NelikkTv/cobbledex-leaderboardV4/images/top3.png"
          echo "Purge jsDelivr…"
          curl -fsS -X PURGE "$URL" || true
          echo "Pause puis warm (remplit le cache avec la nouvelle image)…"
          sleep 3
          curl -fsS -I "$URL" || true
          echo "Lien fixe: $URL"

      - name: Fin
        run: |
          echo "✅ Terminé."
          echo "Lien fixe : https://cdn.jsdelivr.net/gh/NelikkTv/cobbledex-leaderboardV4/images/top3.png"
