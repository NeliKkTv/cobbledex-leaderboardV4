name: Cron leaderboard (robuste)

on:
  schedule:
    - cron: "*/15 * * * *"    # toutes les 15 minutes UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (si présents)
        run: |
          set -e
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "Pas de requirements.txt, on continue."
          fi

      - name: Normaliser/forcer le config.ini maître et propager
        shell: bash
        run: |
          set -e

          ROOT_CFG="./config.ini"
          if [ ! -f "$ROOT_CFG" ]; then
            echo "::error ::config.ini introuvable à la racine du repo."
            exit 1
          fi

          # 1) Normalise CRLF -> LF
          python - <<'PY'
import io
p = "config.ini"
with open(p, "rb") as f:
    data = f.read()
data = data.replace(b"\r\n", b"\n")
with open(p, "wb") as f:
    f.write(data)
print("config.ini normalisé (LF).")
PY

          # 2) Ecrire/forcer mode = sftp dans la section [MODE]
          python - <<'PY'
import configparser, io, sys

p = "config.ini"
cfg = configparser.ConfigParser()
# conserver la casse des options
cfg.optionxform = str
with open(p, "r", encoding="utf-8") as f:
    s = f.read()

# Si pas de section [MODE], on la crée en tête
if "[MODE]" not in s:
    s = s.rstrip() + "\n\n[MODE]\nmode = sftp\n"

# On réécrit proprement : remplace la ligne "mode = ..." dans [MODE] par "mode = sftp"
lines = s.splitlines()
out = []
in_mode = False
touched = False
for line in lines:
    if line.strip().startswith("[") and line.strip().endswith("]"):
        in_mode = (line.strip().lower() == "[mode]")
        out.append(line)
        continue
    if in_mode and line.strip().lower().startswith("mode"):
        out.append("mode = sftp")
        touched = True
    else:
        out.append(line)

if in_mode and not touched:
    out.append("mode = sftp")

with open(p, "w", encoding="utf-8") as f:
    f.write("\n".join(out) + "\n")
print("Section [MODE] forcée sur 'mode = sftp'.")
PY

          echo "----- config.ini maître (raccourci) -----"
          sed -n '1,120p' "$ROOT_CFG"

          # 3) Propager ce config.ini maître à tout autre config.ini éventuellement présent
          while IFS= read -r f; do
            if [ "$f" != "./config.ini" ]; then
              echo "Propagate vers $f"
              cp -f "$ROOT_CFG" "$f"
            fi
          done < <(find . -type f -name "config.ini" | sort)

      - name: Run python main.py (racine)
        run: |
          set -e
          python --version
          ls -la
          # Lancer depuis la racine (main.py doit être à la racine du repo)
          python main.py

      - name: Commit & push changes (images/top3.png)
        if: always()
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          # Ne commit que s'il y a des modifications (image régénérée, etc.)
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update from cron"
            git push
          else
            echo "Aucun changement à pousser."
          fi
